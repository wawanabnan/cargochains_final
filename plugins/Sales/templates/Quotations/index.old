<?php
/**
 * Sales.Quotations index – AdminLTE tidy layout
 * Pastikan controller mengirim $quotations dan pakai contain(['Customer'])
 */
?>

<div class="container-fluid px-0">

  <!-- FILTERS (GET) -->
  <?= $this->Form->create(null, ['type' => 'get', 'class' => 'mb-3']) ?>
  <div class="row g-2 align-items-end">

    <div class="col-12 col-md-3">
      <?= $this->Form->control('q', [
        'label' => __('Search'),
        'value' => $this->request->getQuery('q'),
        'class' => 'form-control',
        'placeholder' => __('Search code or customer…'),
      ]) ?>
    </div>

    <div class="col-6 col-md-2">
      <?= $this->Form->control('status', [
        'label' => __('Status'),
        'options' => ['DRAFT'=>'DRAFT','SENT'=>'SENT','CONFIRMED'=>'CONFIRMED','APPROVED'=>'APPROVED','CANCELED'=>'CANCELED'],
        'empty' => __('All'),
        'value' => $this->request->getQuery('status'),
        'class' => 'form-select',
      ]) ?>
    </div>

    <div class="col-6 col-md-2">
      <?= $this->Form->control('from', [
        'label' => __('From'),
        'type'  => 'date',
        'value' => $this->request->getQuery('from'),
        'class' => 'form-control',
      ]) ?>
    </div>

    <div class="col-6 col-md-2">
      <?= $this->Form->control('to', [
        'label' => __('To'),
        'type'  => 'date',
        'value' => $this->request->getQuery('to'),
        'class' => 'form-control',
      ]) ?>
    </div>

    <div class="col-6 col-md-2">
      <?= $this->Form->control('group', [
        'label'   => __('Group By'),
        'options' => ['status'=>'Status','customer'=>'Customer'],
        'empty'   => __('None'),
        'value'   => $this->request->getQuery('group'),
        'class'   => 'form-select',
      ]) ?>
    </div>

    <div class="col-12 col-md-1 d-grid">
      <?= $this->Form->button(__('Filter'), ['class' => 'btn btn-primary']) ?>
    </div>

  </div>
  <?= $this->Form->end() ?>

  <!-- BULK (POST) -->
  <?= $this->Form->create(null, ['url' => ['action' => 'bulk'], 'type' => 'post', 'class' => 'mb-2']) ?>
    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <div class="d-flex align-items-center gap-2">
        <label class="mb-0 me-1"><?= __('Bulk Action') ?></label>
        <select name="bulk_action" class="form-select form-select-sm w-auto">
          <option value=""><?= __('Choose…') ?></option>
          <option value="status"><?= __('Change Status') ?></option>
          <option value="export"><?= __('Export') ?></option>
          <option value="email"><?= __('Send Email') ?></option>
          <option value="po"><?= __('Generate PO') ?></option>
        </select>
      </div>
      <button type="submit" class="btn btn-sm btn-secondary"><?= __('Apply') ?></button>
      <div class="ms-auto">
        <?= $this->Html->link(__('New Quotation'), ['action' => 'add'], ['class' => 'btn btn-sm btn-primary']) ?>
      </div>
    </div>

    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="sticky-col start bg-white">
                <input type="checkbox" id="checkAll">
              </th>		
			  <th><?= $this->Paginator->sort('number') ?></th>
               <th><?= $this->Paginator->sort('customer_id') ?></th>
               <th><?= $this->Paginator->sort('date') ?></th>
               <th><?= $this->Paginator->sort('valid_until') ?></th>
               <th><?= $this->Paginator->sort('sales_service_id') ?></th>
               <th><?= $this->Paginator->sort('sales_user_id','Sales Person') ?></th>
			   <th><?= $this->Paginator->sort('currency_id') ?></th>
               <th><?= $this->Paginator->sort('payment_term_id') ?></th>
	           <th><?= $this->Paginator->sort('grand_total') ?></th>
			   <th><?= $this->Paginator->sort('status','Status') ?></th>
  

            </tr>
          </thead>
          <tbody>
          <?php foreach ($quotations as $q): ?>
            <tr>
                    <td><?= h($quotation->number) ?></td>
                    <td><?= $quotation->hasValue('customer') ? $this->Html->link($quotation->customer->name, ['controller' => 'Partners', 'action' => 'view', $quotation->customer->id]) : '' ?></td>
                    <td><?= h($quotation->date) ?></td>
                    <td><?= h($quotation->valid_until) ?></td>
                    <td><?= $quotation->hasValue('sales_service') ? $this->Html->link($quotation->sales_service->name, ['controller' => 'SalesServices', 'action' => 'view', $quotation->sales_service->id]) : '' ?></td>
                    <td><?= $quotation->sales_user_id === null ? '' : $this->Number->format($quotation->sales_user_id) ?></td>
					<td><?= h($quotation->currency_id) ?></td>
                    <td><?= $quotation->payment_term_id === null ? '' : $this->Number->format($quotation->payment_term_id) ?></td>
                    <td><?= $quotation->grand_total === null ? '' : $this->Number->format($quotation->grand_total) ?></td>
					<td><?= h($quotation->status) ?></td>
                                </tr>
          <?php endforeach; ?>
          </tbody>
        </table>
      </div>

      <div class="card-footer d-flex justify-content-between align-items-center">
        <div><?= $this->Paginator->counter() ?></div>
        <div class="btn-group">
          <?= $this->Paginator->first('<<') ?>
          <?= $this->Paginator->prev('<') ?>
          <?= $this->Paginator->numbers(['url' => $this->request->getQueryParams()]) ?>
          <?= $this->Paginator->next('>') ?>
          <?= $this->Paginator->last('>>') ?>
        </div>
      </div>
    </div>
  <?= $this->Form->end() ?>

</div>

<?php $this->start('css'); ?>
<style>
  .table thead th { white-space: nowrap; }
  .sticky-col.start { position: sticky; left: 0; z-index: 1; background: #fff; }
  .clickable-row { cursor: pointer; }
</style>
<?php $this->end(); ?>

<?php $this->start('script'); ?>
<script>
  const checkAll = document.getElementById('checkAll');
  if (checkAll) {
    checkAll.addEventListener('change', e => {
      document.querySelectorAll('.row-check').forEach(cb => cb.checked = e.target.checked);
    });
  }
  document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', e => {
      if (e.target.closest('input,button,a,select,label')) return;
      window.location = row.dataset.href;
    });
  });
</script>
<?php $this->end(); ?>
